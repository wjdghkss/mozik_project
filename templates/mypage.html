{% extends "base.html" %}
{% block content %}
<section class="mypage-hero">
    <div>
        <p class="eyebrow">My Page</p>
        <h1>ë§ˆì´í˜ì´ì§€</h1>
        <p class="subtext">
            ê³„ì • ì •ë³´ë¥¼ ê´€ë¦¬í•˜ê³  ì„¤ì •ì„ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”.
        </p>
    </div>
</section>

<section class="mypage-container">
    <div class="mypage-grid">
        <!-- ì‚¬ìš©ì ì •ë³´ ì¹´ë“œ -->
        <div class="mypage-card">
            <div class="mypage-card__header">
                <h2>ì‚¬ìš©ì ì •ë³´</h2>
            </div>
            <div class="mypage-card__body">
                <div class="user-profile">
                    <div class="user-avatar-large">
                        {% if user_info and user_info.name and user_info.name|length > 0 %}
                            {{ user_info.name[0] }}
                        {% else %}
                            ì‚¬ìš©
                        {% endif %}
                    </div>
                    <div class="user-profile__info">
                        <div class="user-profile__name">
                            {% if user_info and user_info.name %}
                                {{ user_info.name }}
                            {% else %}
                                ì‚¬ìš©ì
                            {% endif %}
                        </div>
                        <div class="user-profile__email">
                            {% if user_info and user_info.email %}
                                {{ user_info.email }}
                            {% else %}
                                ì´ë©”ì¼ ì—†ìŒ
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì´ë©”ì¼ ë³€ê²½ -->
        <div class="mypage-card">
            <div class="mypage-card__header">
                <h2>ì´ë©”ì¼ ë³€ê²½</h2>
            </div>
            <div class="mypage-card__body">
                <button type="button" class="action-btn" onclick="toggleForm('emailForm')">
                    ì´ë©”ì¼ ë³€ê²½í•˜ê¸°
                </button>
                <div class="slide-form" id="emailForm">
                    <form method="POST" action="{{ url_for('change_email') }}" class="mypage-form">
                        <div class="form-field">
                            <label for="new_email">ìƒˆ ì´ë©”ì¼</label>
                            <input type="email" id="new_email" name="new_email" required placeholder="ìƒˆ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="form-field">
                            <label for="password_email">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="password_email" name="password" required placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <button type="submit" class="form-btn">ì´ë©”ì¼ ë³€ê²½</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
        <div class="mypage-card">
            <div class="mypage-card__header">
                <h2>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
            </div>
            <div class="mypage-card__body">
                <button type="button" class="action-btn" onclick="toggleForm('passwordForm')">
                    ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•˜ê¸°
                </button>
                <div class="slide-form" id="passwordForm">
                    <form method="POST" action="{{ url_for('change_password') }}" class="mypage-form">
                        <div class="form-field">
                            <label for="current_password">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="current_password" name="current_password" required placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="form-field">
                            <label for="new_password">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="new_password" name="new_password" required placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="form-field">
                            <label for="confirm_password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" id="confirm_password" name="confirm_password" required placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <button type="submit" class="form-btn">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ë³¸ì¸ ì–¼êµ´ ë“±ë¡ -->
        <div class="mypage-card">
            <div class="mypage-card__header">
                <h2>ë³¸ì¸ ì–¼êµ´ ë“±ë¡</h2>
            </div>
            <div class="mypage-card__body">
                {% if user_info and user_info.face_image %}
                <div class="face-preview">
                    <p>ë“±ë¡ëœ ì–¼êµ´:</p>
                    <img src="{{ url_for('uploaded_file', filename=user_info.face_image) }}" alt="ë“±ë¡ëœ ì–¼êµ´">
                </div>
                {% endif %}
                <button type="button" class="action-btn" onclick="toggleForm('faceForm')">
                    {% if user_info and user_info.face_image %}ì–¼êµ´ ì‚¬ì§„ ë³€ê²½í•˜ê¸°{% else %}ì–¼êµ´ ì‚¬ì§„ ë“±ë¡í•˜ê¸°{% endif %}
                </button>
                <div class="slide-form" id="faceForm">
                    <form method="POST" action="{{ url_for('register_face') }}" enctype="multipart/form-data" class="mypage-form">
                        <div class="form-field">
                            <label for="face_image">ì–¼êµ´ ì‚¬ì§„ (ì„ íƒì‚¬í•­)</label>
                            <div class="file-upload-area">
                                <input type="file" id="face_image" name="face_image" accept="image/*">
                                <label for="face_image" class="file-upload-label">
                                    <span class="file-upload-icon">ğŸ“·</span>
                                    <span class="file-upload-text">ì‚¬ì§„ ì„ íƒ</span>
                                </label>
                            </div>
                            <p class="form-hint">ë³¸ì¸ì˜ ì–¼êµ´ì´ ëª…í™•í•˜ê²Œ ë³´ì´ëŠ” ì‚¬ì§„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”. (ì„ íƒì‚¬í•­)</p>
                        </div>
                        <button type="submit" class="form-btn">ì–¼êµ´ ë“±ë¡</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ê³„ì • ì‚­ì œ -->
        <div class="mypage-card mypage-card--danger">
            <div class="mypage-card__header">
                <h2>ê³„ì • ì‚­ì œ</h2>
            </div>
            <div class="mypage-card__body">
                <p class="danger-text">ê³„ì •ì„ ì‚­ì œí•˜ë©´ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <button type="button" class="action-btn action-btn--danger" onclick="toggleForm('deleteForm')">
                    ê³„ì • ì‚­ì œí•˜ê¸°
                </button>
                <div class="slide-form" id="deleteForm">
                    <form method="POST" action="{{ url_for('delete_account') }}" class="mypage-form" onsubmit="return confirm('ì •ë§ë¡œ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
                        <div class="form-field">
                            <label for="delete_password">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" id="delete_password" name="password" required placeholder="ê³„ì • ì‚­ì œë¥¼ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <button type="submit" class="form-btn form-btn--danger">ê³„ì • ì‚­ì œ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

{% if messages %}
<div class="mypage-messages">
    {% for message in messages %}
    <div class="message message--{{ message.type }}">
        {{ message.text }}
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('face_image');
    const fileLabel = document.querySelector('.file-upload-label');
    
    if (fileInput && fileLabel) {
        fileInput.addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || 'ì‚¬ì§„ ì„ íƒ';
            const textSpan = fileLabel.querySelector('.file-upload-text');
            if (textSpan) {
                textSpan.textContent = fileName;
            }
        });
    }
});

function toggleForm(formId) {
    const form = document.getElementById(formId);
    if (!form) return;
    
    const isOpen = form.classList.contains('active');
    
    // ëª¨ë“  í¼ ë‹«ê¸°
    document.querySelectorAll('.slide-form').forEach(f => {
        f.classList.remove('active');
    });
    
    // í´ë¦­í•œ í¼ì´ ë‹«í˜€ìˆì—ˆë‹¤ë©´ ì—´ê¸°
    if (!isOpen) {
        form.classList.add('active');
        // ìŠ¤í¬ë¡¤ì„ í¼ ìœ„ì¹˜ë¡œ ì´ë™
        setTimeout(() => {
            form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    }
}
</script>
{% endblock %}
