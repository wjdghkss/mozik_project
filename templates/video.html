{% extends "base.html" %}
{% block content %}
<section class="upload-hero">
    <div>
        <p class="eyebrow">Workspace</p>
        <h1>동영상을 불러오고<br>몇 가지 옵션만 선택하세요.</h1>
        <p class="subtext">
            모자이크 처리 강도와 탐지 방식을 조절하고, 제외 프레임을 직접 선택할 수 있어요.
            실제 처리 결과는 오른쪽 미리보기에서 확인하게 됩니다.
        </p>
    </div>
</section>

<section class="upload-workspace">
    <aside class="control-panel">
        <form method="POST" enctype="multipart/form-data" class="upload-form" action="{{ url_for('upload_video') }}">
            <input type="hidden" name="file_type" value="video">
            <div class="panel-group">
                <label class="panel-label">① 동영상 파일 불러오기</label>
                <label class="file-drop">
                    <input type="file" name="file" accept="video/*" required>
                    <span>동영상 선택 또는 드래그</span>
                </label>
            </div>

            <div class="panel-group">
                <label class="panel-label">② 블러 강도</label>
                <div class="blur-control">
                    <div class="blur-input-wrapper">
                        <input
                            type="range"
                            id="blurRange"
                            name="blur_strength"
                            class="blur-slider"
                            min="0"
                            max="100"
                            value="0"
                        >
                        <input
                            type="number"
                            id="blurValue"
                            class="blur-number-input"
                            min="0"
                            max="100"
                            value="0"
                            inputmode="numeric"
                        >
                    </div>
                    <div class="blur-labels">
                        <span>약</span>
                        <span>강</span>
                    </div>
                </div>
            </div>

            <div class="panel-group toggles">
                <label class="panel-label">③ 자동 탐지 옵션</label>
                <label class="toggle">
                    <input type="checkbox" checked>
                    <span>자동 얼굴 모자이크</span>
                </label>
                <label class="toggle">
                    <input type="checkbox" checked>
                    <span>전체 프레임 자동 탐지</span>
                </label>
                <label class="toggle">
                    <input type="checkbox">
                    <span>탐지된 얼굴만 적용</span>
                </label>
            </div>

            <div class="panel-group">
                <div class="panel-label-row">
                    <label class="panel-label">④ 탐지된 얼굴 (현재 프레임)</label>
                    <div class="face-controls">
                        <button type="button" class="face-control-btn">모두 선택</button>
                        <button type="button" class="face-control-btn">모두 해제</button>
                    </div>
                </div>
                <div class="face-grid">
                    <div class="face-card placeholder">
                        <div class="face-thumb"></div>
                        <div class="face-info">
                            <span class="face-label">Face 1</span>
                            <p>탐지된 얼굴이 여기에 표시됩니다.</p>
                        </div>
                        <button type="button" class="face-exclude-btn">이 얼굴 전체 제외</button>
                    </div>
                    <div class="face-card placeholder">
                        <div class="face-thumb"></div>
                        <div class="face-info">
                            <span class="face-label">Face 2</span>
                            <p>파일을 선택하면 목록이 채워집니다.</p>
                        </div>
                        <button type="button" class="face-exclude-btn">이 얼굴 전체 제외</button>
                    </div>
                </div>
            </div>

            <div class="panel-group">
                <label class="panel-label">⑤ 모자이크 제외 대상(영상 전체)</label>
                <div class="exclude-panel">
                    <div class="exclude-list">
                        <p class="exclude-empty">현재 제외된 대상 없음</p>
                    </div>
                    <div class="exclude-actions">
                        <button type="button" class="exclude-btn">선택 삭제</button>
                        <button type="button" class="exclude-btn">전체 삭제</button>
                    </div>
                </div>
            </div>

            <div class="panel-group actions">
                <button type="submit" class="primary">모자이크 적용</button>
                <button type="reset" class="ghost">초기화</button>
            </div>
        </form>
    </aside>

    <section class="preview-panel">
        <header>
            <div>
                <p class="eyebrow">Preview</p>
                <h3>모자이크 결과 미리보기</h3>
            </div>
            <div class="preview-actions">
                <button type="button">재생</button>
                <button type="button">정지</button>
            </div>
        </header>
        <div class="preview-stage">
            <p>동영상을 업로드하면 미리보기가 여기에 표시됩니다.</p>
        </div>
    </section>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const blurRange = document.getElementById('blurRange');
    const blurValue = document.getElementById('blurValue');
    
    if (!blurRange || !blurValue) {
        console.error('블러 강도 컨트롤 요소를 찾을 수 없습니다.');
        return;
    }
    
    // 초기 값 동기화
    blurValue.value = blurRange.value;
    
    // 슬라이더 값 변경 시 숫자 입력 필드 업데이트
    blurRange.addEventListener('input', function() {
        blurValue.value = this.value;
    });
    
    blurRange.addEventListener('change', function() {
        blurValue.value = this.value;
    });
    
    // 숫자 입력 필드 값 변경 시 슬라이더 업데이트
    blurValue.addEventListener('input', function() {
        let value = this.value.trim();
        
        if (value === '' || value === '-') {
            value = 0;
        } else {
            value = parseInt(value);
            if (isNaN(value)) {
                value = 0;
            }
        }
        
        if (value > 100) {
            value = 100;
        }
        if (value < 0) {
            value = 0;
        }
        
        this.value = value;
        blurRange.value = value;
    });
    
    // 키보드 이벤트 처리
    blurValue.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowUp') {
            e.preventDefault();
            let value = parseInt(this.value) || 0;
            value = Math.min(value + 1, 100);
            this.value = value;
            blurRange.value = value;
            return;
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            let value = parseInt(this.value) || 0;
            value = Math.max(value - 1, 0);
            this.value = value;
            blurRange.value = value;
            return;
        }
        
        const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Enter'];
        const isNumber = /[0-9]/.test(e.key);
        const isAllowed = allowedKeys.includes(e.key);
        
        if (!isNumber && !isAllowed) {
            e.preventDefault();
        }
    });
    
    // 포커스 아웃 시 값 검증
    blurValue.addEventListener('blur', function() {
        let value = this.value.trim();
        
        if (value === '' || value === '-') {
            value = 0;
        } else {
            value = parseInt(value);
            if (isNaN(value)) {
                value = 0;
            }
        }
        
        if (value > 100) {
            value = 100;
        }
        if (value < 0) {
            value = 0;
        }
        
        this.value = value;
        blurRange.value = value;
    });
});
</script>
{% endblock %}


