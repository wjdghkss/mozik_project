{% extends "base.html" %}
{% block content %}
<section class="upload-hero">
    <div>
        <p class="eyebrow">Workspace</p>
        <h1>사진을 불러오고<br>몇 가지 옵션만 선택하세요.</h1>
        <p class="subtext">
            모자이크 처리 강도와 탐지 방식을 조절하고, 제외할 얼굴을 직접 선택할 수 있어요.
            실제 처리 결과는 오른쪽 미리보기에서 확인하게 됩니다.
        </p>
    </div>
</section>

<section class="upload-workspace">
    <aside class="control-panel">
        <form method="POST" enctype="multipart/form-data" class="upload-form" action="{{ url_for('upload_image') }}">
            <input type="hidden" name="file_type" value="image">
            <div class="panel-group">
                <label class="panel-label">① 사진 파일 불러오기</label>
                <label class="file-drop">
                    <input type="file" name="file" accept="image/*" required>
                    <span>사진 선택 또는 드래그</span>
                </label>
            </div>

            <div class="panel-group">
                <label class="panel-label">② 블러 강도</label>
                <div class="blur-control">
                    <div class="blur-input-wrapper">
                        <input
                            type="range"
                            id="blurRangeImage"
                            name="blur_strength"
                            class="blur-slider"
                            min="0"
                            max="100"
                            value="0"
                        >
                        <input
                            type="number"
                            id="blurValueImage"
                            class="blur-number-input"
                            min="0"
                            max="100"
                            value="0"
                            inputmode="numeric"
                        >
                    </div>
                    <div class="blur-labels">
                        <span>약</span>
                        <span>강</span>
                    </div>
                </div>
            </div>

            <div class="panel-group toggles">
                <label class="panel-label">③ 자동 탐지 옵션</label>
                <label class="toggle">
                    <input type="checkbox" checked>
                    <span>자동 얼굴 모자이크</span>
                </label>
                <label class="toggle">
                    <input type="checkbox" checked>
                    <span>탐지된 얼굴만 적용</span>
                </label>
            </div>

            <div class="panel-group">
                <div class="panel-label-row">
                    <label class="panel-label">④ 탐지된 얼굴</label>
                    <div class="face-controls">
                        <button type="button" class="face-control-btn">모두 선택</button>
                        <button type="button" class="face-control-btn">모두 해제</button>
                    </div>
                </div>
                <div class="face-grid">
                    <div class="face-card placeholder">
                        <div class="face-thumb"></div>
                        <div class="face-info">
                            <span class="face-label">Face 1</span>
                            <p>탐지된 얼굴이 여기에 표시됩니다.</p>
                        </div>
                        <button type="button" class="face-exclude-btn">이 얼굴 제외</button>
                    </div>
                </div>
            </div>

            <div class="panel-group actions">
                <button type="submit" class="primary">모자이크 적용</button>
                <button type="reset" class="ghost">초기화</button>
            </div>
        </form>
    </aside>

    <section class="preview-panel">
        <header>
            <div>
                <p class="eyebrow">Preview</p>
                <h3>모자이크 결과 미리보기</h3>
            </div>
        </header>
        <div class="preview-stage">
            <p>사진을 업로드하면 미리보기가 여기에 표시됩니다.</p>
        </div>
    </section>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const blurRangeImage = document.getElementById('blurRangeImage');
    const blurValueImage = document.getElementById('blurValueImage');
    
    if (!blurRangeImage || !blurValueImage) {
        console.error('블러 강도 컨트롤 요소를 찾을 수 없습니다.');
        return;
    }
    
    // 초기 값 동기화
    blurValueImage.value = blurRangeImage.value;
    
    // 슬라이더 값 변경 시 숫자 입력 필드 업데이트
    blurRangeImage.addEventListener('input', function() {
        blurValueImage.value = this.value;
    });
    
    blurRangeImage.addEventListener('change', function() {
        blurValueImage.value = this.value;
    });
    
    // 숫자 입력 필드 값 변경 시 슬라이더 업데이트
    blurValueImage.addEventListener('input', function() {
        let value = this.value.trim();
        
        if (value === '' || value === '-') {
            value = 0;
        } else {
            value = parseInt(value);
            if (isNaN(value)) {
                value = 0;
            }
        }
        
        if (value > 100) {
            value = 100;
        }
        if (value < 0) {
            value = 0;
        }
        
        this.value = value;
        blurRangeImage.value = value;
    });
    
    // 키보드 이벤트 처리
    blurValueImage.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowUp') {
            e.preventDefault();
            let value = parseInt(this.value) || 0;
            value = Math.min(value + 1, 100);
            this.value = value;
            blurRangeImage.value = value;
            return;
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            let value = parseInt(this.value) || 0;
            value = Math.max(value - 1, 0);
            this.value = value;
            blurRangeImage.value = value;
            return;
        }
        
        const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Enter'];
        const isNumber = /[0-9]/.test(e.key);
        const isAllowed = allowedKeys.includes(e.key);
        
        if (!isNumber && !isAllowed) {
            e.preventDefault();
        }
    });
    
    // 포커스 아웃 시 값 검증
    blurValueImage.addEventListener('blur', function() {
        let value = this.value.trim();
        
        if (value === '' || value === '-') {
            value = 0;
        } else {
            value = parseInt(value);
            if (isNaN(value)) {
                value = 0;
            }
        }
        
        if (value > 100) {
            value = 100;
        }
        if (value < 0) {
            value = 0;
        }
        
        this.value = value;
        blurRangeImage.value = value;
    });
});
</script>
{% endblock %}


